<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[å¤æ ‘æ­£èŒ‚]]></title>
  <link href="http://summertreee.github.io/atom.xml" rel="self"/>
  <link href="http://summertreee.github.io/"/>
  <updated>2015-05-22T21:42:26+08:00</updated>
  <id>http://summertreee.github.io/</id>
  <author>
    <name><![CDATA[æ¢ç‚œV]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[AFNetworking2.0ä½¿ç”¨å¿ƒå¾—]]></title>
    <link href="http://summertreee.github.io/blog/afnetworking2-dot-0shi-yong-xin-de.html/"/>
    <updated>2015-05-13T13:56:23+08:00</updated>
    <id>http://summertreee.github.io/blog/afnetworking2-dot-0shi-yong-xin-de</id>
    <content type="html"><![CDATA[<p>è¿™æ®µæ—¶é—´è¦å°†å…¬å¸é¡¹ç›®ä¸­çš„ç½‘ç»œå¼•æ“ç”±<a href="http://allseeing-i.com/ASIHTTPRequest/">ASIHTTPRequest</a>æ›¿æ¢ä¸º<a href="https://github.com/AFNetworking/AFNetworking">AFNetworking</a>,æ›¿æ¢çš„è¿‡ç¨‹æ¯”è¾ƒæ›²æŠ˜ï¼Œåœ¨æ­¤è®°å½•ä¸‹è‡ªå·±æ›¿æ¢è¿‡ç¨‹ä¸­å¾—å¿ƒå¾—ï¼š</p>

<h3>1ã€å»ºç«‹æ•°æ®è¯·æ±‚ä¸­ä»‹è€…</h3>

<p>å»ºç«‹<code>ä¸­ä»‹è€…</code>æ˜¯æŒ‡é¡¹ç›®ä¸­çš„æ•°æ®è¯·æ±‚éƒ½é€šè¿‡å®ƒå»å®ç°ï¼Œè€Œä¸æ˜¯æ¯ä¸€ä¸ªæ•°æ®è¯·æ±‚éƒ½ç›´æ¥ä¸<code>AFNetworking</code>æ‰“äº¤é“ï¼Œè¿™æ ·åšçš„å¥½å¤„æ˜¯ï¼š</p>

<ul>
<li>å°†ç½‘ç»œè¯·æ±‚ä¸ç¬¬ä¸‰æ–¹åº“ä¾èµ–éš”ç¦»å¼€æ¥ï¼Œæ–¹ä¾¿ä»¥åå¯¹ç¬¬ä¸‰æ–¹åº“çš„æ›¿æ¢ã€‚</li>
<li>æ–¹ä¾¿å¤„ç†ç½‘ç»œè¯·æ±‚çš„å…¬å…±é€»è¾‘ã€‚</li>
</ul>


<p>-</p>

<h3>2ã€ä½¿ç”¨completionQueue</h3>

<p>é»˜è®¤æƒ…å†µä¸‹<code>AFURLConnectionOperation</code>æˆ–è€…<code>AFHTTPRequestOperation</code>è¯·æ±‚ç»“æŸä»¥åä¼šåœ¨ä¸»çº¿ç¨‹å°†ç»“æœä¼ é€’å›æ¥ï¼Œå¦‚æœä½ è¦å°†è¯·æ±‚çš„ç»“æœåšä¸€äº›è€—æ—¶çš„å¤æ‚çš„å¤„ç†ï¼Œå°±ä¼š<em>block</em>ä½ä¸»çº¿ç¨‹ï¼Œæ‰€ä»¥è¿™ç§æƒ…å†µä¸‹ä½ å°±éœ€è¦å¯¹è¯·æ±‚çš„Operationä¼ é€’<code>completionQueue</code>å‚æ•°ï¼š</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>AFHTTPRequestOperation *request = [[AFHTTPRequestOperation alloc] initWithRequest:urlrequest];
</span><span class='line'>
</span><span class='line'>request.responseSerializer = [AFJSONResponseSerializer serializer];
</span><span class='line'>//è®¾ç½®å›è°ƒçš„queueï¼Œé»˜è®¤æ˜¯åœ¨mainQueueæ‰§è¡Œblockå›è°ƒ
</span><span class='line'>request.completionQueue = your_request_operation_completion_queue();
</span><span class='line'>[request setCompletionBlockWithSuccess:^(AFHTTPRequestOperation *operation, id responseObject) {
</span><span class='line'>         //è®¾ç½®äº†'completionQueue'åï¼Œå°±å¯ä»¥åœ¨è¿™é‡Œå¤„ç†å¤æ‚çš„é€»è¾‘
</span><span class='line'>         //ä¸ç”¨æ‹…å¿ƒblockä½äº†ä¸»çº¿ç¨‹
</span><span class='line'>    } failure:^(AFHTTPRequestOperation *operation, NSError *error) {
</span><span class='line'>
</span><span class='line'> }];
</span><span class='line'> [request start];
</span></code></pre></td></tr></table></div></figure>


<h3>3ã€å¦‚ä½•çŸ¥é“AFHTTPRequestOperationManageræ‰§è¡Œå®Œæˆ</h3>

<p>å¼€å§‹ä»¥ä¸ºç›´æ¥è®¾ç½®<code>AFHTTPRequestOperationManager</code>çš„<em>completionGroup</em>ï¼Œç„¶ååˆ©ç”¨<code>dispatch_group_notify</code>æ¥è·å–operationQueueæ‰§è¡Œç»“æŸçš„é€šçŸ¥ï¼Œæœ€åæ‰å‘ç°ï¼Œè¿™æ ·æ ¹æœ¬ä¸è¡Œï¼Œçœ‹äº†æºç æ‰çŸ¥é“ï¼š<code>AFHTTPRequestOperationManager</code>ç›´æ¥å°†<em>completionGroup</em>èµ‹å€¼ç»™äº†ä»–çš„æ¯ä¸€ä¸ª<em>operation</em>ï¼Œåœ¨<em>operation</em>çš„completionBlocké‡Œé¢åˆ©ç”¨<em>completionGroup</em>ï¼Œæ¥ç¡®ä¿åœ¨operationçš„å¤„ç†å®Œæˆåï¼Œå°†completionBlockç½®ä¸ºnilï¼Œé˜²æ­¢å¾ªç¯å¼•ç”¨ã€‚</p>

<p>è™½ç„¶è¯´è¿™æ ·ä¸èƒ½çŸ¥é“<code>AFHTTPRequestOperationManager</code>ä»€ä¹ˆæ—¶å€™æ‰§è¡Œå®Œæˆï¼Œä½†æ˜¯ç”Ÿæ´»è¿˜å¾—ç»§ç»­ä¸‹å»å•Šï¼åœ¨<code>AFURLConnectionOperation</code>ä¸­æœ‰ä¸€ä¸ªæ–¹æ³•å«ï¼š</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>+ (NSArray *)batchOfRequestOperations:(NSArray *)operations
</span><span class='line'>                        progressBlock:(void (^)(NSUInteger numberOfFinishedOperations, NSUInteger totalNumberOfOperations))progressBlock
</span><span class='line'>                      completionBlock:(void (^)(NSArray *operations))completionBlock;
</span></code></pre></td></tr></table></div></figure>


<p>è¿™ä¸ªæ–¹æ³•å°±æ˜¯èƒ½å¤Ÿå‘ä¸€ç»„è¯·æ±‚ï¼Œè·Ÿ<code>AFHTTPRequestOperationManager</code>æ¯”èµ·æ¥çš„ç¼ºç‚¹å°±æ˜¯æ²¡æ³•è®¾ç½®å¹¶å‘æ•°ï¼Œä½†æ˜¯å®ƒå´èƒ½å®ç°æ£€æµ‹ä¸€ç»„è¯·æ±‚ä»€ä¹ˆæ—¶å€™ç»“æŸï¼Œèƒ½æ£€æµ‹å®Œæˆäº†å¤šå°‘è¯·æ±‚ï¼Œå®ƒæ˜¯æ€ä¹ˆåšåˆ°çš„å‘¢ï¼Ÿ</p>

<p>åŸæ¥ä»–ä¹Ÿæ˜¯åˆ©ç”¨<strong>dispatch_group_async</strong>å’Œ<strong>dispatch_group_notify</strong></p>

<p>ä¸€èˆ¬çš„æˆ‘ä»¬è¦æŠŠä¸€ä¸ªä»»åŠ¡åŠ å…¥ä¸€ä¸ªgroupé‡Œæ˜¯è¿™æ ·ï¼š</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>dispatch_group_async(group, queue, ^{
</span><span class='line'>    block();
</span><span class='line'>});
</span></code></pre></td></tr></table></div></figure>


<p>è¿™ä¸ªå†™æ³•ç­‰ä»·äº</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>dispatch_async(queue, ^{
</span><span class='line'>    dispatch_group_enter(group);
</span><span class='line'>    block()
</span><span class='line'>    dispatch_group_leave(group);
</span><span class='line'>});
</span></code></pre></td></tr></table></div></figure>


<p>å¦‚æœè¦æŠŠä¸€ä¸ªå¼‚æ­¥ä»»åŠ¡åŠ å…¥groupï¼Œè¿™æ ·å°±è¡Œä¸é€šäº†ï¼š</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>dispatch_group_async(group, queue, ^{
</span><span class='line'>    [self performBlock:^(){
</span><span class='line'>        block();
</span><span class='line'>    }];
</span><span class='line'>    //æœªæ‰§è¡Œåˆ°block() groupä»»åŠ¡å°±å·²ç»å®Œæˆäº†
</span><span class='line'>});
</span></code></pre></td></tr></table></div></figure>


<p>è¿™æ˜¯å°±éœ€è¦ç”¨åˆ°<code>batchOfRequestOperations</code>é‡Œçš„å®ç°äº†ï¼š</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>dispatch_group_enter(group);
</span><span class='line'>[self performBlock:^(){
</span><span class='line'>    block();
</span><span class='line'>    dispatch_group_leave(group);
</span><span class='line'>}];
</span></code></pre></td></tr></table></div></figure>


<p>å…¶å®è¿™ä¸ªå’Œå¼•ç”¨è®¡æ•°å·®ä¸å¤šï¼Œ<em>dispatch_group_enter</em>æ—¶å¼•ç”¨è®¡æ•°+1ï¼Œ<em>dispatch_group_leave</em>æ—¶å¼•ç”¨è®¡æ•°-1ï¼Œå¼•ç”¨è®¡æ•°ä¸º0æ—¶æ‰§è¡Œ<em>dispatch_group_notify</em>çš„å†…å®¹ã€‚å…·ä½“è¿‡ç¨‹å¤§è‡´å¦‚ä¸‹ï¼š</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>AFHTTPRequestOperationManager *downloadManager = [AFHTTPRequestOperationManager manager];
</span><span class='line'>    //è®¾ç½®æœ€å¤§å¹¶å‘æ•°
</span><span class='line'>    [downloadManager.operationQueue setMaxConcurrentOperationCount:([NSProcessInfo processInfo].processorCount) * 2];
</span><span class='line'>    //åˆ›å»ºä¸€ä¸ªgroup
</span><span class='line'>    __block dispatch_group_t group = dispatch_group_create();
</span><span class='line'>    for (NSURL *url in urlArray) {
</span><span class='line'>        NSURLRequest *requestUrl = [NSURLRequest requestWithURL:url];
</span><span class='line'>        AFHTTPRequestOperation *requestOperation = [[AFHTTPRequestOperation alloc] initWithRequest:requestUrl];
</span><span class='line'>        [requestOperation setCompletionBlockWithSuccess:^(AFHTTPRequestOperation *operation, id responseObject) {
</span><span class='line'>            dispatch_group_leave(group);
</span><span class='line'>            
</span><span class='line'>        } failure:^(AFHTTPRequestOperation *operation, NSError *error) {
</span><span class='line'>            dispatch_group_leave(group);
</span><span class='line'>            
</span><span class='line'>        }];
</span><span class='line'>        //å°†è¯·æ±‚åŠ å…¥é˜Ÿåˆ—ä¸­
</span><span class='line'>        [downloadManager.operationQueue addOperation:requestOperation];
</span><span class='line'>        dispatch_group_enter(group);
</span><span class='line'>    }
</span><span class='line'>    
</span><span class='line'>    dispatch_group_notify(group, dispatch_get_main_queue(), ^{
</span><span class='line'>        //å…¨éƒ¨è¯·æ±‚å®Œæˆ
</span><span class='line'>        
</span><span class='line'>    });  </span></code></pre></td></tr></table></div></figure>


<p></p>

<h3>4ã€å®ç°æ–­ç‚¹ç»­ä¼ </h3>

<p><code>AFNetworking</code>è™½ç„¶æ”¯æŒæ–‡ä»¶ä¸‹è½½çš„æš‚åœå’Œç»§ç»­ï¼Œä½†æ˜¯å½“ç¼“å­˜æ¸…ç©ºé‡æ–°å¯åŠ¨æ—¶ï¼Œå®ƒå¹¶æ²¡æœ‰è®°å½•ä¸‹ä¸‹è½½çš„çŠ¶æ€ï¼Œæ— æ³•ç»­ä¼ ï¼Œä½†æ˜¯å¯ä»¥é€šè¿‡<a href="http://https://github.com/steipete/AFDownloadRequestOperation">AFDownloadRequestOperation</a>æ¥ç®€å•çš„å®ç°ï¼Œå…¶å®è¿‡ç¨‹ä¹Ÿä¸æ˜¯å¾ˆå¤æ‚ï¼Œå¤§è‡´å¦‚ä¸‹ï¼Œæ„Ÿå…´è¶£çš„æœ‹å‹å¯ä»¥é˜…è¯»<code>AFDownloadRequestOperation</code>æ˜¯å®ç°éƒ¨åˆ†ï¼š</p>

<p>1ã€è®¾ç½®<code>AFHTTPRequestOperation</code>çš„è¯·æ±‚<code>NSMutableURLRequest</code><em>HTTPHeader</em>çš„<strong>Range</strong>å­—æ®µã€‚</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>NSMutableURLRequest *mutableURLRequest = [self.request mutableCopy];
</span><span class='line'>//offsetæ˜¯æŒ‡æ–­ç‚¹ç»­ä¼ æ–‡ä»¶å·²ç»ä¸‹è½½çš„å¤§å°
</span><span class='line'>[mutableURLRequest setValue:[NSString stringWithFormat:@"bytes=%llu-", offset] forHTTPHeaderField:@"Range"];</span></code></pre></td></tr></table></div></figure>


<p></p>

<p>2ã€è®¾ç½®<code>AFHTTPRequestOperation</code>çš„<em>outputStream</em>å±æ€§ã€‚</p>

<pre><code class="` "> //downloadPathæ˜¯æŒ‡æ–‡ä»¶ä¸‹è½½å­˜æ”¾çš„è·¯å¾„
downloadOperation.outputStream = [NSOutputStream outputStreamToFileAtPath:downloadPath append:YES];
</code></pre>

<h3>ç»“å°¾</h3>

<p>å¯¹äº<code>ASIHTTPRequest</code>å’Œ<code>AFNetworking</code>çš„æ¯”è¾ƒç½‘ä¸Šæœ‰å¾ˆå¤šå¾ˆå¥½çš„æ–‡ç« ï¼Œä¸€æœä¸€å¤§æŠŠï¼Œå¯¹äºæ™®é€šçš„ä½¿ç”¨æ¥è¯´æ„Ÿè§‰åŒºåˆ«ä¸å¤§ï¼Œè¯·æ±‚é€Ÿåº¦ä»€ä¹ˆçš„ä¹Ÿæ²¡ä»€ä¹ˆæ„Ÿè§‰ï¼Œä»¥ä¸Šè‹¥æœ‰é”™è¯¯ï¼Œè¿˜æœ›å¤§å®¶å¤šå¤š
æŒ‡æ­£ğŸ˜ƒã€‚</p>
]]></content>
  </entry>
  
</feed>
